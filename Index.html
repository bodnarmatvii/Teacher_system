<div x-data="adminModule()" x-init="init()">
  
  <div x-show="subView === 'menu'" style="padding:20px;">
    <h3 style="color:#666; margin-top:0;">Панель Адміністратора</h3>
    
    <div class="dashboard-grid">
      
      <div class="module-card" 
           @click="subView = 'access'" 
           x-show="$root.can('action_access_ctrl')"
           style="border-left:4px solid #d32f2f;">
        <span class="material-icons-round module-icon" style="color:#d32f2f;">lock_person</span>
        <div class="module-title">Керування Доступом</div>
        <div style="font-size:12px; color:#999;">Ролі та Права</div>
      </div>

      </div>
  </div>

  <div x-show="subView === 'access'" style="padding:10px; max-width:900px; margin:0 auto;">
    <button @click="subView = 'menu'" style="background:none; border:none; cursor:pointer; display:flex; align-items:center; color:#666; margin-bottom:10px;">
      <span class="material-icons-round">arrow_back</span> Назад в меню
    </button>

    <div style="display:flex; gap:20px;">
      
      <div style="width:200px; flex-shrink:0;">
        <div style="font-weight:bold; margin-bottom:10px; color:#444;">Суб'єкт права:</div>
        
        <template x-for="r in roles" :key="r.name">
          <div @click="select(r)" class="list-item" :class="{'active': selected.name === r.name}">
            <span class="material-icons-round" style="font-size:16px;">badge</span>
            <span x-text="r.name"></span>
          </div>
        </template>
        
        <button @click="addRole()" style="width:100%; margin-top:10px; padding:8px; border:1px dashed #ccc; background:none;">+ Додати Роль</button>
      </div>

      <div style="flex:1; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.05);" x-show="selected.name">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">
          Права для: <span x-text="selected.name" style="color:#1a73e8;"></span>
        </h3>

        <template x-for="cat in getCategories()" :key="cat">
          <div style="margin-bottom:20px;">
            <div style="font-size:11px; font-weight:bold; color:#999; text-transform:uppercase; margin-bottom:5px;" x-text="cat"></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
              
              <template x-for="cap in config.capabilities.filter(c => c.category === cat)" :key="cap.key">
                <label style="display:flex; align-items:center; gap:10px; padding:8px; background:#f9f9f9; border-radius:4px; cursor:pointer;">
                  <input type="checkbox" :value="cap.key" x-model="selected.perms">
                  <span style="font-size:13px;" x-text="cap.label"></span>
                </label>
              </template>

            </div>
          </div>
        </template>

        <button class="btn-primary" @click="save()">Зберегти права</button>
      </div>

    </div>
  </div>

  <script>
    function adminModule() {
      return {
        subView: 'menu',
        roles: [],
        selected: { name:'', perms:[] },
        config: { capabilities: [] },

        init() {
          this.config = this.$root.config; // Беремо конфіг з ядра
          this.loadRoles();
        },
        
        loadRoles() {
          google.script.run.withSuccessHandler(res => this.roles = res).apiGetRoles();
        },
        
        select(r) { this.selected = JSON.parse(JSON.stringify(r)); },
        
        getCategories() {
          return [...new Set(this.config.capabilities.map(c => c.category))];
        },

        save() {
          this.$root.notify("Збереження...");
          google.script.run.withSuccessHandler(res => {
            this.$root.notify("Збережено");
            this.loadRoles();
          }).apiSaveRole(this.selected.name, this.selected.perms);
        },

        addRole() {
          let name = prompt("Назва ролі (напр. methodist):");
          if(name) {
            let newRole = {name: name, perms:[]};
            this.roles.push(newRole);
            this.selected = newRole;
          }
        }
      }
    }
  </script>
  <style>
    .list-item { padding:10px; background:white; margin-bottom:5px; border-radius:6px; cursor:pointer; display:flex; gap:8px; align-items:center; border:1px solid transparent; }
    .list-item.active { border-color:#1a73e8; background:#e8f0fe; color:#1a73e8; font-weight:bold; }
  </style>
</div>