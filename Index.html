<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Teacher System</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    [x-cloak] { display: none !important; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
    * { box-sizing: border-box; }

    /* LOGIN */
    .login-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 360px; text-align: center; }
    select, input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
    .btn-primary { width: 100%; padding: 14px; background: #2c3e50; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .error-text { color: #e74c3c; font-size: 14px; margin-top: 10px; min-height: 20px; }

    /* HEADER */
    header { background: #2c3e50; color: white; height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
    .nav-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .user-info { text-align: center; line-height: 1.2; }
    .user-name { font-weight: bold; font-size: 15px; }
    .user-role { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; }

    /* BODY & GRID */
    .app-body { flex: 1; overflow-y: auto; }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px; max-width: 800px; margin: 0 auto; }
    .module-card { background: white; padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; height: 140px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px solid transparent; }
    .module-card:active { transform: scale(0.95); }
    .module-icon { font-size: 36px; margin-bottom: 10px; color: #2c3e50; }
    .module-title { font-weight: bold; color: #333; }
    
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; z-index: 999; }
  </style>
</head>

<body x-data="app()" x-cloak>

  <template x-if="!isLoggedIn">
  <div class="login-wrapper">
    <div class="card">
      <h2 style="margin-top:0; color:#2c3e50;">Teacher System</h2>
      
      <input type="text" x-model="form.login" style="margin-bottom: 5px;" 
             placeholder="ðŸ“§ ÐŸÐ¾ÑˆÑ‚Ð° Ð°Ð±Ð¾ ðŸ“ž Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½" :disabled="loading" 
             @keyup.enter="login()">
      
      <input type="password" x-model="form.pass" placeholder="ÐŸÐ°Ñ€Ð¾Ð»ÑŒ" 
             @keyup.enter="login()" :disabled="loading">
      
      <button class="btn-primary" @click="login()" :disabled="loading || !form.login || !form.pass">
        <span x-text="loading ? 'â³' : 'Ð£Ð²Ñ–Ð¹Ñ‚Ð¸'"></span>
      </button>
      <div class="error-text" x-text="errorMsg"></div>
    </div>
  </div>
</template>

  <template x-if="isLoggedIn">
    <div style="display: flex; flex-direction: column; height: 100%;">
      <header>
        <button class="nav-btn" x-show="history.length > 0" @click="goBack()">
          <span class="material-icons-round">arrow_back</span>
        </button>
        <div style="width:40px;" x-show="history.length === 0"></div>

        <div class="user-info">
          <div class="user-name" x-text="pageTitle === 'Ð“Ð¾Ð»Ð¾Ð²Ð½Ð°' ? user.name : pageTitle"></div>
          <div x-show="pageTitle === 'Ð“Ð¾Ð»Ð¾Ð²Ð½Ð°'" class="user-role" x-text="user.role"></div>
        </div>

        <button class="nav-btn" @click="logout()"><span class="material-icons-round">logout</span></button>
      </header>

      <div class="app-body">
        <template x-if="currentView === 'dashboard'"> <?!= include('dashboard'); ?> </template>
        <template x-if="currentView === 'grading'">   <?!= include('grading'); ?> </template>
        <template x-if="currentView === 'schedule'">  <?!= include('schedule'); ?> </template>
        <template x-if="currentView === 'students'">  <?!= include('students'); ?> </template>
        <template x-if="currentView === 'load'">      <?!= include('load'); ?> </template>
        <template x-if="currentView === 'admin'">     <?!= include('admin'); ?> </template>
      </div>
    </div>
  </template>

  <div x-show="toastMsg" x-transition.opacity class="toast" x-text="toastMsg"></div>

  <script>
  function app() {
    return {
      isLoggedIn: false, loading: false, loginList: [], errorMsg: '', toastMsg: '',
      user: { name: '', id: '', role: '', permissions: [] },
      form: { login: '', pass: '' }, // ðŸ‘ˆ Ð—ÐœÐ†ÐÐ 1: Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ 'login' Ð·Ð°Ð¼Ñ–ÑÑ‚ÑŒ 'id'
      currentView: 'dashboard', pageTitle: 'Ð“Ð¾Ð»Ð¾Ð²Ð½Ð°', history: [],

      init() {
        const token = localStorage.getItem('auth_token');
        if (token) this.checkSession(token); 
        // ðŸ‘ˆ Ð—ÐœÐ†ÐÐ 2: Ð’Ð¸Ð´Ð°Ð»ÐµÐ½Ð¾ loadList(), Ð¾ÑÐºÑ–Ð»ÑŒÐºÐ¸ ÑÐ¿Ð¸ÑÐ¾Ðº ID Ð±Ñ–Ð»ÑŒÑˆÐµ Ð½Ðµ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±ÐµÐ½
      },

      canAccess(module) {
        if (!this.isLoggedIn) return false;
        var r = (this.user.role || "").toLowerCase();
        // ÐÐ´Ð¼Ñ–Ð½ Ð¼Ð°Ñ” Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ð´Ð¾ Ð²ÑÑŒÐ¾Ð³Ð¾
        if (r === 'admin') return true;
        if (this.user.permissions.includes('*')) return true;
        // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ðµ Ð¿Ñ€Ð°Ð²Ð¾
        return this.user.permissions.includes(module);
      },

      navigate(view, title) {
        this.history.push({ view: this.currentView, title: this.pageTitle });
        this.currentView = view; 
        this.pageTitle = title || 'ÐœÐ¾Ð´ÑƒÐ»ÑŒ';
      },
      goBack() {
        if (this.history.length) {
          const prev = this.history.pop();
          this.currentView = prev.view; this.pageTitle = prev.title;
        }
      },
      // loadList() Ñ„ÑƒÐ½ÐºÑ†Ñ–ÑŽ Ð²Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾, Ð²Ð¾Ð½Ð° Ð±Ñ–Ð»ÑŒÑˆÐµ Ð½Ðµ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð°
      
      login() {
        this.loading = true; this.errorMsg = '';
        google.script.run.withSuccessHandler(res => {
          this.loading = false;
          if(res.success) { localStorage.setItem('auth_token', res.token); this.setUser(res.user); }
          else this.errorMsg = res.msg;
        }).apiLogin(this.form.login, this.form.pass); // ðŸ‘ˆ Ð—ÐœÐ†ÐÐ 3: ÐŸÐµÑ€ÐµÐ´Ð°Ñ”Ð¼Ð¾ this.form.login
      },
      checkSession(token) {
        google.script.run.withSuccessHandler(res => {
          if(res.success) this.setUser(res.user); else this.logout();
        }).apiMe(token);
      },
      logout() {
        localStorage.removeItem('auth_token');
        this.isLoggedIn = false; this.history = []; this.currentView = 'dashboard';
        // loadList() Ð±Ñ–Ð»ÑŒÑˆÐµ Ð½Ðµ Ð²Ð¸ÐºÐ»Ð¸ÐºÐ°Ñ”Ð¼Ð¾
      },
      setUser(u) { this.user = u; this.isLoggedIn = true; this.currentView = 'dashboard'; this.pageTitle = 'Ð“Ð¾Ð»Ð¾Ð²Ð½Ð°'; },
      
      sendMark(val) {
        if(!this.topic) { this.showToast("âš ï¸ Ð’ÐºÐ°Ð¶Ñ–Ñ‚ÑŒ Ñ‚ÐµÐ¼Ñƒ!"); return; }
        this.showToast("â³ Ð—Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ...");
        const token = localStorage.getItem('auth_token');
        google.script.run.withSuccessHandler(r => this.showToast(r)).apiSaveLog(token, val, this.topic);
      },
      showToast(msg) { this.toastMsg = msg; setTimeout(() => this.toastMsg = '', 3000); }
    }
  }
</script>
</body>
</html>