<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Teacher System</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    [x-cloak] { display: none !important; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
    * { box-sizing: border-box; }

    /* LOGIN */
    .login-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 360px; text-align: center; }
    select, input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
    .btn-primary { width: 100%; padding: 14px; background: #2c3e50; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .error-text { color: #e74c3c; font-size: 14px; margin-top: 10px; min-height: 20px; }

    /* HEADER */
    header { background: #2c3e50; color: white; height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
    .nav-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .user-info { text-align: center; line-height: 1.2; }
    .user-name { font-weight: bold; font-size: 15px; }
    .user-role { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; }

    /* BODY & GRID */
    .app-body { flex: 1; overflow-y: auto; }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px; max-width: 800px; margin: 0 auto; }
    .module-card { background: white; padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; height: 140px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px solid transparent; }
    .module-card:active { transform: scale(0.95); }
    .module-icon { font-size: 36px; margin-bottom: 10px; color: #2c3e50; }
    .module-title { font-weight: bold; color: #333; }
    
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; z-index: 999; }
  </style>
</head>

<body x-data="app()" x-cloak>

  <template x-if="!isLoggedIn">
  <div class="login-wrapper">
    <div class="card">
      <h2 style="margin-top:0; color:#2c3e50;" x-text="isRegistering ? '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è' : 'Teacher System'"></h2>

      <template x-if="!isRegistering">
        <div>
          <input type="text" x-model="form.login" style="margin-bottom: 5px;" 
                 placeholder="üìß –ü–æ—à—Ç–∞ –∞–±–æ üìû –¢–µ–ª–µ—Ñ–æ–Ω" :disabled="loading" 
                 @keyup.enter="login()">
          
          <input type="password" x-model="form.pass" placeholder="–ü–∞—Ä–æ–ª—å" 
                 @keyup.enter="login()" :disabled="loading">
          
          <button class="btn-primary" @click="login()" :disabled="loading || !form.login || !form.pass">
            <span x-text="loading ? '‚è≥' : '–£–≤—ñ–π—Ç–∏'"></span>
          </button>
          
          <div class="error-text" x-text="errorMsg"></div>
          
          <button @click="isRegistering = true; errorMsg=''" style="margin-top:10px; background:none; border:none; color:#1a73e8; cursor:pointer;">
            –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è
          </button>
        </div>
      </template>

      <template x-if="isRegistering">
        <div>
          <input type="text" x-model="regForm.name" placeholder="–ü–Ü–ë" :disabled="loading">
          <input type="text" x-model="regForm.phone" placeholder="üìû –¢–µ–ª–µ—Ñ–æ–Ω" :disabled="loading">
          <input type="email" x-model="regForm.email" placeholder="üìß –ü–æ—à—Ç–∞" :disabled="loading">
          
          <input type="password" x-model="regForm.pass" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å" :disabled="loading">
          <input type="password" x-model="regForm.passConfirm" placeholder="–ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –ø–∞—Ä–æ–ª—å" :disabled="loading">

          <button class="btn-primary" 
                  @click="register()" 
                  :disabled="loading || !regForm.name || !regForm.email || !regForm.phone || !regForm.pass || !regForm.passConfirm">
            <span x-text="loading ? '‚è≥' : '–ü–æ–¥–∞—Ç–∏ –∑–∞—è–≤–∫—É'"></span>
          </button>
          
          <div class="error-text" x-text="regMsg || '–ó–∞—è–≤–∫–∞ –±—É–¥–µ —Ä–æ–∑–≥–ª—è–Ω—É—Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º'"></div>
          
          <button @click="isRegistering = false; regMsg=''" style="margin-top:10px; background:none; border:none; color:#1a73e8; cursor:pointer;">
            –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –≤—Ö–æ–¥—É
          </button>
        </div>
      </template>
    </div>
  </div>
</template>

  <template x-if="isLoggedIn">
    <div style="display: flex; flex-direction: column; height: 100%;">
      <header>
        <button class="nav-btn" x-show="history.length > 0" @click="goBack()">
          <span class="material-icons-round">arrow_back</span>
        </button>
        <div style="width:40px;" x-show="history.length === 0"></div>

        <div class="user-info">
          <div class="user-name" x-text="pageTitle === '–ì–æ–ª–æ–≤–Ω–∞' ? user.name : pageTitle"></div>
          <div x-show="pageTitle === '–ì–æ–ª–æ–≤–Ω–∞'" class="user-role" x-text="user.role"></div>
        </div>

        <button class="nav-btn" @click="logout()"><span class="material-icons-round">logout</span></button>
      </header>

      <div class="app-body">
        <template x-if="currentView === 'dashboard'"> <?!= include('dashboard'); ?> </template>
        <template x-if="currentView === 'grading'">   <?!= include('grading'); ?> </template>
        <template x-if="currentView === 'schedule'">  <?!= include('schedule'); ?> </template>
        <template x-if="currentView === 'students'">  <?!= include('students'); ?> </template>
        <template x-if="currentView === 'load'">      <?!= include('load'); ?> </template>
        <template x-if="currentView === 'admin'">     <?!= include('admin'); ?> </template>
      </div>
    </div>
  </template>

  <div x-show="toastMsg" x-transition.opacity class="toast" x-text="toastMsg"></div>

  <script>
  function app() {
    return {
      isLoggedIn: false, loading: false, loginList: [], errorMsg: '', toastMsg: '',
      user: { name: '', id: '', role: '', permissions: [] },
      form: { login: '', pass: '' }, // üëà –ó–ú–Ü–ù–ï–ù–ê –§–û–†–ú–ê –í–•–û–î–£
      currentView: 'dashboard', pageTitle: '–ì–æ–ª–æ–≤–Ω–∞', history: [],
      
      // üëà –î–û–î–ê–ù–û: –°—Ç–∞–Ω –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
      isRegistering: false, 
      regForm: { name: '', phone: '', email: '', pass: '', passConfirm: '' },
      regMsg: '',

      init() {
        const token = localStorage.getItem('auth_token');
        if (token) this.checkSession(token);
      },

      canAccess(module) {
        if (!this.isLoggedIn) return false;
        var r = (this.user.role || "").toLowerCase();
        if (r === 'admin') return true;
        if (this.user.permissions.includes('*')) return true;
        return this.user.permissions.includes(module);
      },

      navigate(view, title) {
        this.history.push({ view: this.currentView, title: this.pageTitle });
        this.currentView = view; 
        this.pageTitle = title || '–ú–æ–¥—É–ª—å';
      },
      goBack() {
        if (this.history.length) {
          const prev = this.history.pop();
          this.currentView = prev.view; this.pageTitle = prev.title;
        }
      },
      
      login() {
        this.loading = true; this.errorMsg = '';
        google.script.run.withSuccessHandler(res => {
          this.loading = false;
          if(res.success) { localStorage.setItem('auth_token', res.token); this.setUser(res.user); }
          else this.errorMsg = res.msg;
        }).apiLogin(this.form.login, this.form.pass);
      },
      
      // üëà –î–û–î–ê–ù–û: –§—É–Ω–∫—Ü—ñ—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
      register() {
        this.loading = true; this.regMsg = '';
        if (this.regForm.pass !== this.regForm.passConfirm) {
          this.regMsg = "‚ùå –ü–∞—Ä–æ–ª—ñ –Ω–µ –∑–±—ñ–≥–∞—é—Ç—å—Å—è!"; 
          this.loading = false; 
          return;
        }
        
        google.script.run.withSuccessHandler(res => {
          this.loading = false;
          this.regMsg = res.msg;
          if(res.success) {
            // –û—á–∏—â–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—Ö—É
            this.regForm = { name: '', phone: '', email: '', pass: '', passConfirm: '' };
            this.form.login = this.regForm.email; // –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø–æ–ª—è –ª–æ–≥—ñ–Ω—É
            
            // –Ø–∫—â–æ –∑–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –Ω–∞ –µ–∫—Ä–∞–Ω –≤—Ö–æ–¥—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏
            if(res.msg.includes("–ó–∞—è–≤–∫–∞")) {
              setTimeout(() => { this.isRegistering = false; this.regMsg = ''; }, 3000); 
            }
          }
        }).apiRegister(
          this.regForm.name,
          this.regForm.phone,
          this.regForm.email,
          this.regForm.pass
        );
      },
      // üëà /–î–û–î–ê–ù–û

      checkSession(token) {
        google.script.run.withSuccessHandler(res => {
          if(res.success) this.setUser(res.user); else this.logout();
        }).apiMe(token);
      },
      logout() {
        localStorage.removeItem('auth_token');
        this.isLoggedIn = false; this.history = []; this.currentView = 'dashboard';
      },
      setUser(u) { this.user = u; this.isLoggedIn = true; this.currentView = 'dashboard'; this.pageTitle = '–ì–æ–ª–æ–≤–Ω–∞'; },
      
      sendMark(val) {
        if(!this.topic) { this.showToast("‚ö†Ô∏è –í–∫–∞–∂—ñ—Ç—å —Ç–µ–º—É!"); return; }
        this.showToast("‚è≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...");
        const token = localStorage.getItem('auth_token');
        google.script.run.withSuccessHandler(r => this.showToast(r)).apiSaveLog(token, val, this.topic);
      },
      showToast(msg) { this.toastMsg = msg; setTimeout(() => this.toastMsg = '', 3000); }
    }
  }
</script>
</body>
</html>